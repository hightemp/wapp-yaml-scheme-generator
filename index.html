<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="favicon.png">

    <title>Node editor</title>
</head>
<body>
    <div id="left-side">
        <div class="top-panel">
            <button id="button-run">Run</button>
            <button id="button-clear">Clear</button>
            <button id="button-log">Log</button>
            <button id="button-save-image-to-file">Save image to file</button>
            <button id="button-save-to-file">Save to file</button>
            <div>
                <a href="https://visjs.github.io/vis-network/examples/">examples</a><br>
                <a href="https://ww3.arb.ca.gov/ei/tools/lib/vis/docs/network.html">docs</a>
                <a href="https://htmlcolorcodes.com/color-names/">colors</a>
            </div>
        </div>
        <div class="top-options">
            <input type="text" id="scheme-name" value="noname_scheme" placeholder="scheme name" style="border: 1px solid grey" />
            <select id="scheme-type-select">
                <option value="yaml_visjs">yaml - visjs</option>
                <option value="yaml_pcs">yaml - project call stack</option>
                <option value="yaml_flowchart" selected>yaml - flowchart</option>
                <option value="json_visjs">json - visjs</option>
            </select>
            <select id="saved-scheme-select"></select>
            <button id="save-scheme" title="save">S</button>
            <button id="load-scheme" title="load">L</button>
            <button id="remove-scheme" title="remove">R</button>
        </div>
        <div id="editor" style=""></div>
        <div class="top-message">
        </div>
    </div>
    <div id="right-side">
        <div id="network"></div>
    </div>
</body>
</html>

<script src="https://ajaxorg.github.io/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="https://visjs.github.io/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.js" integrity="sha512-CwxrLIN0dww6lRc/oKeZiI9oGlOob2HPMU0Yu0g+P3/G1cuTii+tt0jpyEKhilfrV7D/zmvKiVPIHUDU6xbBxg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="./default_schemes_list.js"></script>

<script>
var oEditor = null;
var oNetwork = null;
var aNodes = [];
var aEdges = [];
var oEl = null;
var oData = {};
var sImageURL = "";
var oOptions = {}
var oDefaultOptions = {}
var aSchemes = [];
var sEditorText = "";

document.body.addEventListener('click', function(e) {
    var sID = e.target.id;

    switch (sID) {
        case "button-run": fnRun(); break;
        case "button-clear": fnClear(); break;
        case "button-log": fnLog(); break;
        case "button-save-image-to-file": fnSaveImageToFile(); break;
        case "button-save-to-file": fnSaveToFile(); break;

        case "save-scheme": fnSaveCurrentScheme(); break;
        case "load-scheme": fnLoadCurrentScheme(); break;
        case "remove-scheme": fnRemoveCurrentScheme(); break;
    }
});

function fnPrepare(oN) {
    return new vis.DataSet(oN);
}

function fnRunVisJS(sText) {
    var oYAML = jsyaml.load(sText);

    aNodes = [];
    aEdges = [];
    oOptions = {};

    if (oYAML.scheme) {
        if (oYAML.scheme.nodes) {
            aNodes = Object.entries(oYAML.scheme.nodes).map((aI) => {
                aI[1].id = aI[0];
                return aI[1];
            })
        } else {
            aErrors.push("oYAML.scheme.nodes - empty")
        }
        if (oYAML.scheme.edges) {
            aEdges = Object.values(oYAML.scheme.edges);
        } else {
            aErrors.push("oYAML.scheme.edges - empty")
        }
        if (oYAML.scheme.options) {
            oOptions = oYAML.scheme.options;
        } else {
            aErrors.push("oYAML.scheme.options - empty")
        }
    } else {
        aErrors.push("oYAML.scheme - empty")
    }

    oData = {
        nodes: fnPrepare(aNodes),
        edges: fnPrepare(aEdges)
    }

    oNetwork.setData(oData);
    oNetwork.setOptions(oOptions);
}

var oPCSStyles = {
    request: {
        color: "orange",
        shape: "dot"
    },
    method: {
        color: "#639AF2",
        shape: "square"
    },
    sql: {
        color: "#E6E6E6",
        shape: "triangle" 
    },
    tpl: {
        color: "#00FA9A",
        shape: "square" 
    },
    inner_edge: {
        length: 400,
        arrows: {
            to: {
                enabled: true
            }
        }
    }
}

var sURLPrefix = `vscode://file/`
var sProjectPath = ``

function fnExtractCalls(aCalls, aNodes) {
    console.log(['aNodes', aNodes ]);
    if (!Array.isArray(aCalls)) return;
    for (var mRow of aCalls) {
        if (typeof mRow == "string") {
            aNodes.push({...oPCSStyles.method, label: mRow});
        } else if (Array.isArray(mRow)) {
            if (mRow[0] in { "GET":1, "POST":1 }) {
                var sL = mRow[0]+`\n`+mRow[1]
                aNodes.push({...oPCSStyles.request, label: sL});
                fnExtractCalls(mRow[2], aNodes);
            } else if (mRow[0] == "sql_fields_select") {
                var sL = `SQL: `+mRow[1]+"."+mRow[2]+`\n`+mRow[3]+":"+mRow[4];
                aNodes.push({...oPCSStyles.sql, label: sL});
                fnExtractCalls(mRow[5], aNodes);
            } else if (mRow[0] == "tpl") {
                var sL = ``+mRow[1]+`\n`+mRow[2]+":"+mRow[3];
                aNodes.push({...oPCSStyles.tpl, label: sL});
                fnExtractCalls(mRow[4], aNodes);
            } else {
                var sL = mRow[0]+"::"+mRow[1]+`\n`+mRow[2]+":"+mRow[3];
                var sURL = `${sURLPrefix}${sProjectPath}${mRow[2]+":"+mRow[3]}`;
                aNodes.push({...oPCSStyles.method, label: sL, url: sURL});
                fnExtractCalls(mRow[4], aNodes);
            }
        }
    }
}

function fnFindNode(sID) {
    return aNodes.filter((oI) => oI.id == sID)[0]
}

function fnFindEdge(sID) {
    return aEdges.filter((oI) => oI.id == sID)[0]
}

function fnPrepareEdgesForCalls(aNodes, aEdges) {
    var oNodes = {}
    var oPrevNode = null;
    for (var [iIndex, oNode] of Object.entries(aNodes)) {
        oNodes[oNode.label] = iIndex;
        oNode.id = iIndex;

        if (oPrevNode) {
            var sFrom = oNodes[oPrevNode.label];
            var sTo = oNodes[oNode.label];

            aEdges.push({
                ...oPCSStyles.inner_edge,
                from: sFrom,
                to: sTo
            });
        }

        oPrevNode = oNode;
    }
}

function fnRunPCS(sText, aErrors) {
    var oYAML = jsyaml.load(sText);

    aNodes = [];
    aEdges = [];
    oOptions = {};

    if (oYAML.scheme) {
        if (oYAML.scheme.calls) {
            // console.log(['oYAML', oYAML ]);
            fnExtractCalls([oYAML.scheme.calls], aNodes)
            fnPrepareEdgesForCalls(aNodes, aEdges);
            // console.log(['>>>', aNodes, aEdges ]);
        } else {
            aErrors.push("oYAML.scheme.calls - empty")
        }

        if (oYAML.scheme.options) {
            oOptions = oYAML.scheme.options;
        } else {
            aErrors.push("oYAML.scheme.options - empty")
        }
    } else {
        aErrors.push("oYAML.scheme - empty")
    }

    oData = {
        nodes: fnPrepare(aNodes),
        edges: fnPrepare(aEdges)
    }

    oNetwork.setData(oData);
    oNetwork.setOptions(oOptions);

    oNetwork.fit();
}

var oFlowChartStyles = {
    condition: {
        color: "orange",
        shape: "diamond"
    },
    method: {
        color: "#639AF2",
        shape: "square"
    },
    begin_end: {
        color: "#E6E6E6",
        shape: "dot" 
    },
    action: {
        color: "#00FA9A",
        shape: "dot" 
    },
    inner_edge: {
        length: 400,
        arrows: {
            to: {
                enabled: true
            }
        }
    }
}

var iNodeIndex = 0;

function fnObjCopy(oO) {
    return JSON.parse(JSON.stringify(oO))
}

function fnExtractFlowchartNodes(aCalls, aNodes, aEdges, oPrevNode=null, sEdgeLabel="") {
    if (!Array.isArray(aCalls)) return;
    // var oPrevNode = null;

    for (var mRow of aCalls) {

        iNodeIndex++;
        var sID = iNodeIndex.toString();
        var sE = '';

        if (typeof mRow == "string") {
            // METHOD

            // LABEL: ...
            if (mRow.match(/^\w+:/)) {
                [sE, sID, mRow] = [...mRow.match(/^(\w+):\s*(.*?)$/)]
            }

            aNodes.push({...oFlowChartStyles.method, label: mRow, id: sID });
            if (oPrevNode) {
                aEdges.push({
                    ...oFlowChartStyles.inner_edge,
                    label: sEdgeLabel,
                    from: oPrevNode.id,
                    to: sID
                });
                sEdgeLabel = "";
            }
            
            oPrevNode = aNodes[aNodes.length-1];
        } else if (Array.isArray(mRow)) {
            // CONDITION
            aNodes.push({...oFlowChartStyles.condition, label: mRow[0], id: sID});
            
            if (oPrevNode) {
                aEdges.push({
                    ...oFlowChartStyles.inner_edge,
                    label: sEdgeLabel,
                    from: oPrevNode.id,
                    to: sID
                });
                sEdgeLabel = "";
            }

            oPrevNode = aNodes[aNodes.length-1];

            // YES
            var sYesID = (++iNodeIndex)+'';
            if (typeof mRow[1] == "string") {
                aNodes.push({...oFlowChartStyles.method, label: mRow[1], id: sYesID});
            } else if (Array.isArray(mRow[1])) {
                fnExtractFlowchartNodes(mRow[1], aNodes, aEdges, fnObjCopy(oPrevNode), "YES");
            }

            // NO
            var sNoID = (++iNodeIndex)+'';
            if (typeof mRow[2] == "string") {
                aNodes.push({...oFlowChartStyles.method, label: mRow[2], id: sNoID});
            } else if (Array.isArray(mRow[2])) {
                fnExtractFlowchartNodes(mRow[2], aNodes, aEdges, fnObjCopy(oPrevNode), "NO");
            }

            // YES
            aEdges.push({
                ...oFlowChartStyles.inner_edge,
                label: "YES",
                from: sID,
                to: sYesID
            });

            // NO
            aEdges.push({
                ...oFlowChartStyles.inner_edge,
                label: "NO",
                from: sID,
                to: sNoID
            });

            // fnExtractFlowchartNodes(mRow[3], aNodes, aEdges, JSON.parse(JSON.stringify(oPrevNode)));
        }
    }
}

// function fnPrepareFlowchartEdges(aNodes, aEdges) {
//     var oNodes = {}
//     var oPrevNode = null;
//     for (var [iIndex, oNode] of Object.entries(aNodes)) {
//         oNodes[oNode.label] = iIndex;
//         oNode.id = iIndex;

//         if (oPrevNode) {
//             if (oNode.label.match(/^(#\w+)/)) {
//                 var sFrom = oNodes[oNode.label].id;
//                 var aM = oNode.label.match(/^(#\w+)(.*)/);
//                 var sTo = aM[1].replace(/#/, '');
//                 // oNode.label = aNodes[sTo].label;
//                 oNode.label = aM[2]

//                 aEdges.push({
//                     ...oFlowChartStyles.inner_edge,
//                     from: sFrom,
//                     to: sTo
//                 });
//             }

//             var sFrom = oNodes[oPrevNode.label];
//             var sTo = oNodes[oNode.label];

//             aEdges.push({
//                 ...oFlowChartStyles.inner_edge,
//                 from: sFrom,
//                 to: sTo
//             });
//         }

//         oPrevNode = oNode;
//     }
// }

function fnRunFlowchart(sText, aErrors) {
    var oYAML = jsyaml.load(sText);

    aNodes = [];
    aEdges = [];
    oOptions = {};
    iNodeIndex = 0;

    if (oYAML.scheme) {
        if (oYAML.scheme.program) {
            fnExtractFlowchartNodes(oYAML.scheme.program, aNodes, aEdges)
            console.log([oYAML.scheme.program, aNodes, aEdges]);
            // fnPrepareFlowchartEdges(aNodes, aEdges);
        } else {
            aErrors.push("oYAML.scheme.program - empty")
        }

        if (oYAML.scheme.options) {
            oOptions = oYAML.scheme.options;
        } else {
            aErrors.push("oYAML.scheme.options - empty")
        }
    } else {
        aErrors.push("oYAML.scheme - empty")
    }

    oData = {
        nodes: fnPrepare(aNodes),
        edges: fnPrepare(aEdges)
    }

    oNetwork.setOptions(oOptions);
    oNetwork.setData(oData);

    oNetwork.fit();
}

function fnRun() {
    var aErrors = []
    try {
        console.error = (...aM) => {
            console.log(aM);
            aErrors.push(aM.join(`\n`))
        }
        document.querySelector('.top-message').innerText = '';
        sEditorText = oEditor.getValue();
        var sType = fnGetSchemeType(); 

        oNetwork.setOptions(oDefaultOptions);

        if (sType == "yaml_visjs") {
            fnRunVisJS(sEditorText, aErrors);
        } else if (sType == "yaml_pcs") {
            fnRunPCS(sEditorText, aErrors);
        } else if (sType == "yaml_flowchart") {
            fnRunFlowchart(sEditorText, aErrors);
        } else if (sType == "json_visjs") {

        }
    } catch (oE) {
        aErrors.push(oE+'')
    }

    document.querySelector('.top-message').innerText = aErrors.join(`\n`);
}
function fnClear() {
    oEditor.setValue('');
}
function fnLog() {

}

function fnSaveCurrentScheme() {
    var sName = fnGetSchemeName();
    fnSaveScheme(sName, sEditorText);
}
function fnLoadCurrentScheme() {
    var sName = fnGetSchemeSavedSchemeName();
    sEditorText = fnLoadScheme(sName);
    // console.log([sName, sEditorText]);
    if (!sEditorText) sEditorText = aDefaultSchemes[0].sValue;
    if (oEditor) oEditor.setValue(sEditorText);
}
function fnRemoveCurrentScheme() {
    var sName = fnGetSchemeSavedSchemeName();
    fnRemoveScheme(sName);
}

function fnSaveSchemes() {
    localStorage.setItem('aSchemes', JSON.stringify(aSchemes));
}
function fnLoadSchemes() {
    try {
        aSchemes = JSON.parse(localStorage.getItem('aSchemes'));
        if (!aSchemes) aSchemes = aDefaultSchemes;
    } catch(oE) {
        aSchemes = aDefaultSchemes;
    }
    fnRenderSchemes();
}
function fnRenderSchemes() {
    var sHTML = ``;
    for (oI of aSchemes) {
        sHTML += `<option value="${oI.sName}" ${oI.sName == 'default_flowchat.yaml' ? 'selected' : ''}>${oI.sName}</option>`
    }
    document.querySelector('#saved-scheme-select').innerHTML = sHTML;
}

function fnSaveScheme(sName, sValue) {
    fnRemoveScheme(sName);
    aSchemes.push({sName, sValue});
    fnSaveSchemes();
    fnLoadSchemes();
}
function fnLoadScheme(sName) {
    return aSchemes.filter((oI) => oI.sName == sName)[0].sValue
}
function fnRemoveScheme(sName) {
    aSchemes = aSchemes.filter((oI) => oI.sName != sName)
}

function fnDownloadFileWithLink(filename, content) {
    const link = document.createElement('a');
    link.download = filename;
    link.href = content;
    link.click();
    link.delete;
}

function fnDownloadFile(filename, content) {
    var blob = new Blob([content]);
    var evt = document.createEvent("HTMLEvents");
    evt.initEvent("click");

    fnDownloadFileWithLink(filename, webkitURL.createObjectURL(blob));
}

function fnGetSchemeName() {
    return document.querySelector('#scheme-name').value
}
function fnGetSchemeType() {
    return document.querySelector('#scheme-type-select').value
}
function fnGetSchemeSavedSchemeName() {
    return document.querySelector('#saved-scheme-select').value
}

function fnSaveImageToFile() {
    fnDownloadFileWithLink(`${fnGetSchemeName()}_${(new Date()).getTime()}.png`, sImageURL);
}
function fnSaveToFile() {
    fnDownloadFile(`${fnGetSchemeName()}_${(new Date()).getTime()}.yaml`, sEditorText);
}

// layout:
//     hierarchical:
//         direction: "LR"
// edges:
//     smooth:
//         type: "continuous"

window.onload = () => {
    fnLoadSchemes();
    fnLoadCurrentScheme();

    oEditor = ace.edit("editor");
    oEditor.getSession().setUseWorker(false);
    oEditor.setTheme("ace/theme/chrome");
    oEditor.getSession().setMode("ace/mode/yaml");
    oEditor.setValue(sEditorText);

    oEditor.setOptions({
        fontFamily: "Consolas",
        fontSize: "10px"
    });

    oEditor.on('change', () => {
        fnRun();
    })

    oEl = document.querySelector('#network')
    oData = {
        nodes: fnPrepare([]),
        edges: fnPrepare([])
    }

    oNetwork = new vis.Network(oEl);

    try {
        oDefaultOptions = oNetwork.getOptions();
    } catch (oE) {
        oDefaultOptions = {}
    }

    oNetwork.on("beforeDrawing", function(ctx) {
        ctx.save();
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height)
        ctx.restore();
    })

    oNetwork.on("afterDrawing", function (ctx) {
        sImageURL = ctx.canvas.toDataURL();
    })

    oNetwork.on("click", function(params) {                              
        if (params.nodes.length == 1) {
            var nodeId = params.nodes[0];
            var oN = fnFindNode(nodeId)
            if (oN.url != null) {
                window.open(oN.url, '_blank');
            }           
        } else if (params.edges.length==1) {
            var edgeId = params.edges[0];       
            var oE = fnFindEdge(edgeId)
            if (oE.url != null) {
                window.open(oE.url, '_blank');
            }           
        } 
    });

    fnRun();
}
</script>

<style>
* {
    border-radius: 0px;
}

body, html {
    padding: 0px;
    margin: 0px;
    height: 100vh;
    width: 100vw;
    overflow: hidden;
}

body {
    font-family: Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

#left-side {
    position: absolute;
    width: 500px;
    height: 100vh;
    border-right: 1px solid rgba(0,0,0,0.1);
}

#editor {
    height: calc(100vh - 141px); 
    width: 500px;
}

#right-side {
    position: absolute;
    right: 0px;
    width: calc(100vw - 500px);
    height: 100vh;
    overflow: scroll;
}

.top-panel {
    height: 30px;
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.top-panel *,
.top-panel {
    font-size: 10px;
}

button {
    border: 1px solid grey;
}
button:hover {
    background: #ddd;
}
button:active {
    background: #eee;
}

.top-panel > div {
    padding: 2px;
}

.top-message {
    columns: 2;
    font-family: monospace;
    height: 100px;
    overflow: auto;
    font-size: 8px;
    padding: 4px;
    white-space: pre-line;
    border: 1px solid rgba(0,0,0,0.1);
}

.top-options {
    display: grid;
    grid-template-columns: 120px 110px 110px 1fr 1fr 1fr;
}
</style>

</body>
</html>